# bazel-demo

Playground for Bazel - Typescript - transitions related examples.

### with_cfg without reset feature

##### Cases:

1.
`bazel build //lib1` and `bazel build //lib2:ts` generate the following error:

```
ERROR: file 'common/bazel/node_modules/.aspect_rules_js/@private+my-tool@0.0.0/node_modules/tslib' is generated by these conflicting actions:
Label: //common/bazel:.aspect_rules_js/node_modules/@private+my-tool@0.0.0
RuleClass: npm_package_store rule
JavaActionClass: class com.google.devtools.build.lib.analysis.starlark.UnresolvedSymlinkAction
Configuration: cf36750f41872150a140ff266c67b24cf24ea210edc310bd2890a59ea3891d5b
Mnemonic: UnresolvedSymlink
Action key: 8e797229be71a9edb86d1b2bb571d9b258d039b33af0186e1a732a6eea40f7de, 8e70c2da2aa1fb628db08ec3399038781bf55369138b97e495126cfdd780edae
Progress message: Creating symlink bazel-out/darwin_arm64-fastbuild/bin/common/bazel/node_modules/.aspect_rules_js/@private+my-tool@0.0.0/node_modules/tslib
Action describeKey: (null)
PrimaryInput: (null)
PrimaryOutput: File:[[<execution_root>]bazel-out/darwin_arm64-fastbuild/bin]common/bazel/node_modules/.aspect_rules_js/@private+my-tool@0.0.0/node_modules/tslib
Owner information: ConfiguredTargetKey{label=//common/bazel:.aspect_rules_js/node_modules/@private+my-tool@0.0.0, config=BuildConfigurationKey[cf36750f41872150a140ff266c67b24cf24ea210edc310bd2890a59ea3891d5b]}
MandatoryInputs: are equal
Outputs: are equal
ERROR: /Users/simona/github/bazel-demos/common/bazel/BUILD:6:22: for common/bazel/node_modules/.aspect_rules_js/@private+my-tool@0.0.0/node_modules/tslib, previous action: action 'Creating symlink bazel-out/darwin_arm64-fastbuild/bin/common/bazel/node_modules/.aspect_rules_js/@private+my-tool@0.0.0/node_modules/tslib', attempted action: action 'Creating symlink bazel-out/darwin_arm64-fastbuild/bin/common/bazel/node_modules/.aspect_rules_js/@private+my-tool@0.0.0/node_modules/tslib'
ERROR: Analysis of target '//lib1:lib1' failed; build aborted: 
INFO: Elapsed time: 0.067s
INFO: 0 processes.
FAILED: Build did NOT complete successfully (0 packages loaded, 0 targets configured)
```

2.
`bazel build //lib2:ts` and `bazel build //tools/my-tool:ts` and `bazel build //tools/my-tool:ts` are working fine.


### with_cfg with reset feature

Uncomment the lines commented from `common/bazel/opt_ts.bzl` for enabling reset features on `deps` attribute for ts_project. 

I may have found two possible bugs:

1. `cannot encode CompilationMode as JSON` error:

```
simona@simonas-mbp bazel-demos % bazel build //lib1:ts         
ERROR: Traceback (most recent call last):
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/transition.bzl", line 21, column 56, in lambda
		return lambda settings, attr: _transition_base_impl(
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/transition.bzl", line 91, column 69, in _transition_base_impl
		new_settings[str(original_settings_label)] = json.encode(settings)
Error in encode: in dict key "//command_line_option:compilation_mode": cannot encode CompilationMode as JSON
ERROR: /Users/simona/github/bazel-demos/tools/my-tool/BUILD:14:15: Errors encountered while applying Starlark transition
ERROR: Analysis of target '//lib1:ts' failed; build aborted: 
INFO: Elapsed time: 0.077s
INFO: 0 processes.
FAILED: Build did NOT complete successfully (1 packages loaded, 2 targets configured)
```

2. `opt_ts_project_reset rule 'ts__deps_0' in package 'lib2' conflicts with existing opt_ts_project_reset rule` error:
```
simona@simonas-mbp bazel-demos % bazel build //lib2:ts
ERROR: Traceback (most recent call last):
	File "/Users/simona/github/bazel-demos/lib2/BUILD", line 9, column 15, in <toplevel>
		opt_ts_project(
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/wrapper.bzl", line 17, column 46, in lambda
		return lambda *, name, **kwargs: _wrapper(
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/wrapper.bzl", line 129, column 48, in _wrapper
		processed_kwargs = _process_attrs_for_reset(
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/wrapper.bzl", line 211, column 42, in _process_attrs_for_reset
		first_pass_attrs[attr] = map_attr(attr_func, attrs[attr])
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/select.bzl", line 7, column 20, in map_attr
		return func(attribute)
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/wrapper.bzl", line 204, column 50, in lambda
		attr_func = lambda dep: _replace_dep_attr(
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/wrapper.bzl", line 226, column 32, in _replace_dep_attr
		_replace_single_dep(
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/wrapper.bzl", line 276, column 21, in _replace_single_dep
		reset_target(
	File "/private/var/tmp/_bazel_simona/3099fbc7895a08f739515284f34cf219/external/with_cfg.bzl~0.2.1/with_cfg/private/wrapper.bzl", line 132, column 68, in lambda
		reset_target = lambda *, name, exports: transitioning_alias(
Error in opt_ts_project_reset: opt_ts_project_reset rule 'ts__deps_0' in package 'lib2' conflicts with existing opt_ts_project_reset rule, defined at /Users/simona/github/bazel-demos/lib2/BUILD:9:15
ERROR: Skipping '//lib2:ts': no such target '//lib2:ts': target 'ts' not declared in package 'lib2' defined by /Users/simona/github/bazel-demos/lib2/BUILD (Tip: use `query "//lib2:*"` to see all the targets in that package)
WARNING: Target pattern parsing failed.
ERROR: no such target '//lib2:ts': target 'ts' not declared in package 'lib2' defined by /Users/simona/github/bazel-demos/lib2/BUILD (Tip: use `query "//lib2:*"` to see all the targets in that package)
INFO: Elapsed time: 0.079s
INFO: 0 processes.
FAILED: Build did NOT complete successfully (1 packages loaded)
```
